services:
  chatbot:
    hostname: chatbot{{.Task.Slot}}
    image: $CONTENTBOT_IMAGE
    configs:
      - source: contentbot_conf
        target: /etc/contentbot/contentbot.conf
    secrets:
      - source: contentbot_secrets_conf
        target: /etc/contentbot/contentbot_secrets.conf
      - source: redis_crt
        target: /etc/contentbot/tls/redis.crt
      - source: redis_key
        target: /etc/contentbot/tls/redis.key
      - source: redis_ca
        target: /etc/contentbot/tls/redis_ca.crt
      - source: kafka_crt
        target: /etc/contentbot/tls/kafka.crt
      - source: kafka_key
        target: /etc/contentbot/tls/kafka.key
      - source: kafka_ca
        target: /etc/contentbot/tls/kafka_ca.crt
    environment:
      PYTHONUNBUFFERED: 1
      DOMAIN: $DOMAIN
      CONFIG_PATH: /etc/contentbot/contentbot.conf
      SECRETS_PATH: /etc/contentbot/contentbot_secrets.conf
    command: chatbot
    deploy:
      mode: replicated
      replicas: $CHATBOT_REPLICAS
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.${STACK}_chatbot == 1
  worker:
    hostname: worker{{.Task.Slot}}
    image: $CONTENTBOT_IMAGE
    configs:
      - source: contentbot_conf
        target: /etc/contentbot/contentbot.conf
    secrets:
      - source: contentbot_secrets_conf
        target: /etc/contentbot/contentbot_secrets.conf
      - source: redis_crt
        target: /etc/contentbot/tls/redis.crt
      - source: redis_key
        target: /etc/contentbot/tls/redis.key
      - source: redis_ca
        target: /etc/contentbot/tls/redis_ca.crt
      - source: kafka_crt
        target: /etc/contentbot/tls/kafka.crt
      - source: kafka_key
        target: /etc/contentbot/tls/kafka.key
      - source: kafka_ca
        target: /etc/contentbot/tls/kafka_ca.crt
    environment:
      PYTHONUNBUFFERED: 1
      DOMAIN: $DOMAIN
      CONFIG_PATH: /etc/contentbot/contentbot.conf
      SECRETS_PATH: /etc/contentbot/contentbot_secrets.conf
    command: worker
    deploy:
      mode: replicated
      replicas: $WORKER_REPLICAS
      placement:
        max_replicas_per_node: 1
        constraints:
          - node.labels.${STACK}_worker == 1

configs:
  contentbot_conf:
    file: $CONFIGS/contentbot.conf

secrets:
  contentbot_secrets_conf:
    file: $SECRETS/contentbot_secrets.conf
  redis_crt:
    file: $SECRETS/redis.crt
  redis_key:
    file: $SECRETS/redis.key
  redis_ca:
    file: $SECRETS/redis_ca.crt
  kafka_crt:
    file: $SECRETS/kafka.crt
  kafka_key:
    file: $SECRETS/kafka.key
  kafka_ca:
    file: $SECRETS/kafka_ca.crt
